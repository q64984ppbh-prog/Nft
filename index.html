<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Recipe Picker</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAKYSURBVFiF7ZdNiFZlGIav5z3vOzM6zqiTH6UxFUYQUm6iIFsUFrXInyBqEUKrNhFBq9oH0SaiFq1qEdEmgoJoEUUF/UCrwCCipIikQGtQZHScGed7z3naYt4ZR+djZiYXQRe8nOc9z31d9/M+cP6D/7qU5aJvnDUL1yPdBawFrgGWAeeBE8AosMfwVSWNXHK4u2t2ZPG9wDbgkYuEHAX2gXYbvhVpFOD6WbNwPfBhv3hrxnwKes7wA0iTks4bbgK2Srol6FvAw8DOi8Uf7O6aHRkDDwCj/eKVwPaQ3gaIlFJvZmZmqLu7+3RKaXU55yeAp4IeAn0MPGtY0ul0Dl8wAEnfAVv7xXFgZ875S0mklJiYmFhZluXdwKvAyx7vEGyX9DjwYs75kKRtwDuGr4GNhqFzwwvAOsODKaVVKSXGx8dvBZ4Oek+wXtKGEMJZSZwbXjDsMLwBbAEeNUz+YQCSeoFtQAk8nlLaALwK7PF4h+AV4AywW9LrwE5Jz0vaYtgk6bnu7u7TFwVIKZ0FPu8X9wGfhBB2xxhPSRJwt6QtkrZK2hRCGA8hvAXslrQXeD6EcDqE8NNFASRxbnjBsAP0BrAFeMzwS4xxH3CfpK2SnpX0PDAp6W3gPUmflmV5IqV0rt1uT10QIIRwRtKBfvFH4OMQwu4Y40+SMLwWQnhO0vPAVsNPkt6V9EFZlp+FEE6mlE4bhiR1Wq3W+F8CpJRawA/94n7gwxDCnhjjEUkYbgwh7DKMGb4Engb2hhDGJZ2XNAVMp5TOG4ZCCJOtVuv3vwTIOR8Hfga+kfRJWZZ7Qwi/SZoGfg0hjEk6GEL4vSzLyZzzVErpjKTJqqomyrKcbLfbExe7B/93+gMkC9nQcSw1XQAAAABJRU5ErkJggg==">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .container {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: scale(0.98);
        }

        #rollButton {
            background-color: #3498db;
            color: white;
            font-size: 1.5rem;
            padding: 20px 40px;
        }

        #rollButton:hover {
            background-color: #2980b9;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        #addButton {
            background-color: #2ecc71;
            color: white;
        }

        #addButton:hover {
            background-color: #27ae60;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        #result {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #result.show {
            display: block;
        }

        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        #viewButton {
            background-color: #9b59b6;
            color: white;
        }

        #viewButton:hover {
            background-color: #8e44ad;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        .recipe-list {
            text-align: left;
            margin-top: 20px;
        }

        .recipe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            margin: 5px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        #rollTenButton {
            background-color: #e67e22;
            color: white;
            font-size: 1.5rem;
            padding: 20px 40px;
        }

        #rollTenButton:hover {
            background-color: #d35400;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .recipe-day {
            position: relative;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .day-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        #exportButton, #importButton {
            background-color: #34495e;
            color: white;
        }

        #exportButton:hover, #importButton:hover {
            background-color: #2c3e50;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 20px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #000;
        }

        #optionsButton {
            background-color: #95a5a6;
            color: white;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #optionsButton:hover {
            background-color: #7f8c8d;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .settings-group input,
        .settings-group textarea {
            margin-bottom: 20px;
        }

        .settings-group input[type="date"],
        .settings-group input[type="time"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            width: 100%;
            padding: 10px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
            color: #2c3e50;
        }

        #createCalendarBtn {
            background-color: #f1c40f;
            color: white;
            display: none;
        }

        #createCalendarBtn:hover {
            background-color: #f39c12;
        }

        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500&display=swap');

        .dice {
            position: fixed;
            font-size: 80px;
            top: 50%;
            left: -100px;
            transform: translateY(-50%);
            animation: rollDice 2s ease-in-out;
            z-index: 1000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes rollDice {
            0% {
                left: -100px;
                transform: translateY(-50%) rotate(0deg);
            }
            50% {
                left: 50%;
                transform: translateY(-50%) rotate(720deg);
            }
            100% {
                left: calc(100% + 100px);
                transform: translateY(-50%) rotate(1440deg);
            }
        }

        .ingredients-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .ingredients-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .ingredients-list li {
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .ingredients-list .item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .ingredients-list input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .ingredients-list .item-text {
            flex: 1;
        }

        .ingredients-list a {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
        }

        .ingredients-list a:hover {
            background-color: #2980b9;
            text-decoration: none;
        }

        .ingredients-btn {
            background-color: #9b59b6;
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.9em;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ingredients-btn:hover {
            background-color: #8e44ad;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .ingredients-btn:active {
            transform: scale(0.98);
        }

        .settings-group textarea {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 100px;
            resize: vertical;
            box-sizing: border-box;
            line-height: 1.4;
            color: #2c3e50;
        }

        .settings-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .ingredient-header {
            background-color: #eee !important;
            font-weight: bold;
            padding: 10px;
            margin-top: 15px !important;
        }

        .ingredient-header:first-child {
            margin-top: 0 !important;
        }

        .regular-items-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            margin-top: 15px;
            cursor: pointer;
            border: none;
            font-size: 1em;
            width: 100%;
        }

        .regular-items-btn:hover {
            background-color: #219a52;
        }

        .save-regulars-btn {
            background-color: #2ecc71;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }

        .save-regulars-btn:hover {
            background-color: #27ae60;
        }

        .regulars-container {
            position: relative;
        }

        #showRegularsBtn {
            margin-top: 20px;
            background-color: #27ae60;
            color: white;
            font-size: 1.2rem;
            padding: 15px 30px;
            border-radius: 50px;
            display: none;
        }

        #showRegularsBtn:hover {
            background-color: #219a52;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        .reroll-btn {
            background-color: #e67e22;
            color: white;
            padding: 5px 10px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .reroll-btn:hover {
            background-color: #d35400;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .danger-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 20px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .danger-btn:hover {
            background-color: #c0392b;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .regulars-buttons {
            display: flex;
            gap: 15px;
            margin: 15px 0 25px 0;
        }

        .regulars-buttons button {
            flex: 1;
            padding: 8px 15px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: white;
            transition: all 0.3s ease;
        }

        .settings-section {
            border-bottom: 2px solid #eee;
            padding-bottom: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            text-align: left;
        }

        .modal-content h2 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2c3e50;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
        }

        /* Add smooth scrolling to the page */
        html {
            scroll-behavior: smooth;
        }

        /* Ensure modal content has proper spacing on mobile */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10px auto;
                padding: 20px;
                width: calc(100% - 40px);
            }

            .regulars-buttons {
                flex-direction: column;
            }

            .regulars-buttons button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dinner Dice üé≤</h1>
        <button id="rollButton" class="btn">Roll the dice</button>
        <button id="rollTenButton" class="btn">Roll the dice for 10 days</button>
        <div id="result"></div>
        <button id="createCalendarBtn" class="btn">Add to Calendar</button>
        <button id="showRegularsBtn" class="btn regular-items-btn">View Regular Shopping Items</button>
    </div>

    <button id="optionsButton" class="btn">‚öôÔ∏è</button>

    <!-- Options Modal -->
    <div id="optionsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Settings</h2>
            
            <div class="settings-section">
                <div class="section-title">Dinner Time Settings</div>
                <div class="settings-group">
                    <label for="dinnerTime">Default Dinner Time:</label>
                    <input type="time" id="dinnerTime" value="18:30">
                    
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate">
                </div>
            </div>

            <div class="settings-section">
                <div class="section-title">Regular Shopping Items</div>
                <div class="regulars-container">
                    <label for="regularItems">Enter your regular shopping items:</label>
                    <textarea id="regularItems" placeholder="Enter items separated by commas or line breaks"></textarea>
                    <div class="regulars-buttons">
                        <button class="save-regulars-btn" onclick="saveRegularItems()">Store Items for Regular Shops</button>
                        <button class="btn" style="background-color: #3498db;" onclick="exportRegularItems()">Export Regular Item List</button>
                        <button class="btn" style="background-color: #9b59b6;" onclick="importRegularItems()">Import Regular Item List</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-title">Recipe Management</div>
                <div class="modal-buttons">
                    <button id="addButton" class="btn">Add Recipe</button>
                    <button id="viewButton" class="btn">View Recipes</button>
                    <button id="exportButton" class="btn">Export CSV</button>
                    <button id="importButton" class="btn">Import CSV</button>
                </div>
                <button id="clearRecipesBtn" class="danger-btn">Clear All Recipes</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" accept=".csv" style="display: none;">

    <!-- Ingredients Modal -->
    <div id="ingredientsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeIngredientsModal()">&times;</span>
            <h2>Ingredients</h2>
            <div id="ingredientsList"></div>
        </div>
    </div>

    <input type="file" id="regularItemsFile" accept=".txt" style="display: none;">

    <script>
        // Function to generate a safe key for cookies
        function makeRecipeKey(index) {
            return `recipe_${index}`;
        }

        // Function to get all recipes from cookies
        function getCookies() {
            const recipes = [];
            const recipePrefix = 'recipe_';
            
            document.cookie.split(';').forEach(cookie => {
                const [key, value] = cookie.trim().split('=');
                if (key.startsWith(recipePrefix)) {
                    try {
                        recipes.push(JSON.parse(decodeURIComponent(value)));
                    } catch (e) {
                        console.error('Error parsing recipe:', e);
                    }
                }
            });
            
            return recipes;
        }

        // Function to save recipes to cookies
        function saveRecipes(recipes) {
            // First, clear all existing recipe cookies
            const recipePrefix = 'recipe_';
            document.cookie.split(';').forEach(cookie => {
                const [key] = cookie.trim().split('=');
                if (key.startsWith(recipePrefix)) {
                    document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
                }
            });

            // Save each recipe as its own cookie
            const oneYear = 365 * 24 * 60 * 60 * 1000;
            const expires = new Date(Date.now() + oneYear).toUTCString();
            
            recipes.forEach((recipe, index) => {
                const key = makeRecipeKey(index);
                document.cookie = `${key}=${encodeURIComponent(JSON.stringify(recipe))}; expires=${expires}; path=/`;
            });
        }

        // Simplified fetchPageTitle function that just returns the URL
        function getRecipeNameFromUrl(url) {
            try {
                // Try to extract a reasonable name from the URL
                const urlObj = new URL(url);
                const pathSegments = urlObj.pathname.split('/').filter(segment => segment.length > 0);
                const lastSegment = pathSegments[pathSegments.length - 1];
                
                // Convert dash/underscore separated words to spaces and capitalize
                return lastSegment
                    .replace(/[-_]/g, ' ')
                    .replace(/\.(html|htm|php|aspx?)$/i, '')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
            } catch (error) {
                return url;
            }
        }

        // Modified addRecipe function
        async function addRecipe() {
            const url = prompt("Enter the recipe URL:");
            if (url) {
                const suggestedName = getRecipeNameFromUrl(url);
                const title = prompt("Recipe name (you can edit this):", suggestedName);
                
                if (title) {
                    const ingredients = prompt("Enter ingredients (comma-separated), or leave empty:", "");
                    const recipes = getCookies();
                    recipes.push({ url, title, ingredients });
                    saveRecipes(recipes);
                    alert("Recipe added successfully!");
                    modal.style.display = "none";  // Close modal after adding
                    viewRecipes(); // Show updated recipe list
                }
            }
        }

        // Function to remove recipe
        function removeRecipe(index) {
            const recipes = getCookies();
            recipes.splice(index, 1);
            saveRecipes(recipes);
            viewRecipes(); // Refresh the list
        }

        // Function to convert URL to "just the recipe" format
        function getCleanRecipeUrl(url) {
            return `https://www.justtherecipe.com/?url=${encodeURIComponent(url)}`;
        }

        // Modified viewRecipes function
        function viewRecipes() {
            const result = document.getElementById('result');
            const recipes = getCookies();
            
            if (recipes.length === 0) {
                result.innerHTML = "No recipes found. Add some recipes first!";
            } else {
                let html = '<div class="recipe-list">';
                recipes.forEach((recipe, index) => {
                    const title = recipe.title || recipe;
                    const url = recipe.url || recipe;
                    const cleanUrl = getCleanRecipeUrl(url);
                    html += `
                        <div class="recipe-item">
                            <div>
                                <a href="${cleanUrl}" target="_blank">${title}</a>
                                ${recipe.ingredients ? 
                                    `<button class="ingredients-btn" onclick="showIngredients('${recipe.ingredients.replace(/'/g, "\\'")}')">Ingredients</button>` 
                                    : ''}
                            </div>
                            <button class="delete-btn" onclick="removeRecipe(${index})">Delete</button>
                        </div>
                    `;
                });
                html += '</div>';
                result.innerHTML = html;
            }
            result.classList.add('show');
            modal.style.display = "none";  // Close modal after showing recipes
        }

        // Modified getRandomRecipe function
        function getRandomRecipe() {
            const recipes = getCookies();
            if (recipes.length === 0) {
                return "No recipes found. Add some recipes first!";
            }
            const randomIndex = Math.floor(Math.random() * recipes.length);
            return recipes[randomIndex];
        }

        // Modify the rollButton event listener
        document.getElementById('rollButton').addEventListener('click', () => {
            animateDiceRoll();
            setTimeout(() => {
                const result = document.getElementById('result');
                const recipe = getRandomRecipe();
                
                if (typeof recipe === 'object') {
                    const cleanUrl = getCleanRecipeUrl(recipe.url);
                    result.innerHTML = `
                        <div class="recipe-item">
                            <div>
                                <a href="${cleanUrl}" target="_blank">${recipe.title}</a>
                                ${recipe.ingredients ? 
                                    `<button class="ingredients-btn" onclick="showIngredients('${recipe.ingredients.replace(/'/g, "\\'")}')">Ingredients</button>` 
                                    : ''}
                            </div>
                        </div>`;
                } else if (recipe.startsWith('http')) {
                    const cleanUrl = getCleanRecipeUrl(recipe);
                    result.innerHTML = `<a href="${cleanUrl}" target="_blank">${recipe}</a>`;
                } else {
                    result.innerHTML = recipe;
                }
                
                result.classList.add('show');
            }, 1000);
        });

        // Function to get multiple random recipes
        function getMultipleRandomRecipes(count) {
            const recipes = getCookies();
            if (recipes.length === 0) {
                return Array(count).fill("No recipes found. Add some recipes first!");
            }
            
            const selected = new Set();
            const results = [];
            
            for (let i = 0; i < count; i++) {
                let attempts = 0;
                let randomIndex;
                
                // Try to get unique recipes, but don't get stuck if we have fewer recipes than requested
                do {
                    randomIndex = Math.floor(Math.random() * recipes.length);
                    attempts++;
                } while (selected.has(randomIndex) && attempts < recipes.length && selected.size < recipes.length);
                
                selected.add(randomIndex);
                results.push(recipes[randomIndex]);
            }
            
            return results;
        }

        // Function to display multiple recipes
        let currentRecipes = []; // Add this at the top of your script

        function displayMultipleRecipes(recipes) {
            currentRecipes = recipes;
            const result = document.getElementById('result');
            let html = '<div class="recipe-grid">';
            
            recipes.forEach((recipe, index) => {
                const dayNumber = index + 1;
                const title = recipe.title || recipe;
                const url = recipe.url || recipe;
                const cleanUrl = getCleanRecipeUrl(url);
                
                html += `
                    <div class="recipe-day" id="day-${dayNumber}">
                        <div class="day-label">Day ${dayNumber}</div>
                        <div>
                            <a href="${cleanUrl}" target="_blank">${title}</a>
                            ${recipe.ingredients ? 
                                `<button class="ingredients-btn" onclick="showIngredients('${recipe.ingredients.replace(/'/g, "\\'")}')">Ingredients</button>` 
                                : ''}
                        </div>
                        <button class="reroll-btn" onclick="rerollDay(${index})">üé≤ Re-roll Day ${dayNumber}</button>
                    </div>
                `;
            });
            
            html += '</div>';
            result.innerHTML = html;
            result.classList.add('show');
            
            // Show the calendar button
            document.getElementById('createCalendarBtn').style.display = 'inline-block';
        }

        // Function to export recipes to CSV
        function exportToCSV() {
            const recipes = getCookies();
            if (recipes.length === 0) {
                alert("No recipes to export!");
                return;
            }

            // Create CSV content
            const csvContent = [
                ['Title', 'URL', 'Ingredients'],
                ...recipes.map(recipe => [
                    recipe.title || '',
                    recipe.url || recipe,
                    recipe.ingredients || ''
                ])
            ].map(row => row.map(cell => 
                `"${(cell || '').replace(/"/g, '""')}"`
            ).join(',')).join('\n');

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'recipes.csv';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to import recipes from CSV
        function importFromCSV(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvContent = event.target.result;
                    // Split into lines and remove empty lines
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    // Skip header row
                    const dataLines = lines.slice(1);
                    
                    const newRecipes = dataLines.map(line => {
                        try {
                            // Find the first two commas to separate title and URL
                            const firstCommaIndex = line.indexOf(',');
                            const secondCommaIndex = line.indexOf(',', firstCommaIndex + 1);
                            
                            if (firstCommaIndex === -1 || secondCommaIndex === -1) return null;
                            
                            const title = line.substring(0, firstCommaIndex).trim();
                            const url = line.substring(firstCommaIndex + 1, secondCommaIndex).trim();
                            const ingredients = line.substring(secondCommaIndex + 1).trim();
                            
                            // Remove any quotes
                            const cleanTitle = title.replace(/^"|"$/g, '');
                            const cleanUrl = url.replace(/^"|"$/g, '');
                            const cleanIngredients = ingredients.replace(/^"|"$/g, '');
                            
                            if (cleanTitle && cleanUrl) {
                                return {
                                    title: cleanTitle,
                                    url: cleanUrl,
                                    ingredients: cleanIngredients
                                };
                            }
                        } catch (e) {
                            console.error('Error parsing line:', line, e);
                        }
                        return null;
                    }).filter(recipe => recipe !== null);

                    if (newRecipes.length === 0) {
                        alert("No valid recipes found in CSV file");
                        return;
                    }

                    console.log('New recipes to import:', newRecipes); // Debug log
                    debugCookies(); // Log current cookies
                    
                    const existingRecipes = getCookies();
                    console.log('Existing recipes:', existingRecipes); // Debug log
                    
                    const mergedRecipes = [...existingRecipes, ...newRecipes];
                    console.log('Merged recipes:', mergedRecipes); // Debug log
                    
                    saveRecipes(mergedRecipes);
                    debugCookies(); // Log cookies after save
                    
                    alert(`Successfully imported ${newRecipes.length} recipes!`);
                    viewRecipes();
                } catch (error) {
                    console.error('Error importing CSV:', error);
                    alert("Error importing CSV file. Please check the file format.");
                }
            };
            reader.readAsText(file);
        }

        // Modal functions
        const modal = document.getElementById('optionsModal');
        const optionsBtn = document.getElementById('optionsButton');
        const closeBtn = document.querySelector('.close-btn');

        optionsBtn.onclick = function() {
            modal.style.display = "block";
        }

        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == document.getElementById('ingredientsModal')) {
                closeIngredientsModal();
            }
        }

        document.getElementById('addButton').addEventListener('click', addRecipe);
        document.getElementById('viewButton').addEventListener('click', viewRecipes);
        document.getElementById('rollTenButton').addEventListener('click', () => {
            animateDiceRoll();
            setTimeout(() => {
                const recipes = getMultipleRandomRecipes(10);
                displayMultipleRecipes(recipes);
            }, 1000); // Show results after 1 second
        });
        document.getElementById('exportButton').addEventListener('click', exportToCSV);
        
        document.getElementById('importButton').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                importFromCSV(file);
                event.target.value = ''; // Reset file input
            }
        });

        // Function to save settings
        function saveSettings() {
            const dinnerTime = document.getElementById('dinnerTime').value;
            const startDate = document.getElementById('startDate').value;
            
            localStorage.setItem('dinnerTime', dinnerTime);
            localStorage.setItem('startDate', startDate);
        }

        // Function to load settings
        function loadSettings() {
            const dinnerTime = localStorage.getItem('dinnerTime') || '18:30';
            const startDate = localStorage.getItem('startDate') || new Date().toISOString().split('T')[0];
            
            // Get regular items from cookie
            const regularItems = document.cookie.split(';')
                .find(row => row.trim().startsWith('regularItems='));
            const regularItemsValue = regularItems ? 
                decodeURIComponent(regularItems.split('=')[1]) : '';
            
            document.getElementById('dinnerTime').value = dinnerTime;
            document.getElementById('startDate').value = startDate;
            document.getElementById('regularItems').value = regularItemsValue;

            // Show/hide regular items button based on whether there are items
            const showRegularsBtn = document.getElementById('showRegularsBtn');
            showRegularsBtn.style.display = regularItemsValue ? 'inline-block' : 'none';
        }

        // Function to create iCal content
        function createICalContent(recipes) {
            const dinnerTime = document.getElementById('dinnerTime').value;
            let startDate = new Date(document.getElementById('startDate').value);
            const [hours, minutes] = dinnerTime.split(':');

            let icalContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Dinner Dice//EN',
                'CALSCALE:GREGORIAN'
            ];

            recipes.forEach((recipe, index) => {
                const eventDate = new Date(startDate);
                eventDate.setDate(startDate.getDate() + index);
                eventDate.setHours(parseInt(hours), parseInt(minutes), 0);

                const title = recipe.title || recipe;
                const url = recipe.url || recipe;
                const cleanUrl = getCleanRecipeUrl(url);
                
                // Create description with ingredients if available
                let description = `Recipe Link: ${cleanUrl}`;
                if (recipe.ingredients) {
                    const ingredientsList = recipe.ingredients
                        .split(',')
                        .map(i => i.trim())
                        .join('\\n- ');
                    description += `\\n\\nIngredients:\\n- ${ingredientsList}`;
                }

                const dateString = eventDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const endDate = new Date(eventDate.getTime() + 60 * 60 * 1000); // 1 hour duration
                const endDateString = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                icalContent = icalContent.concat([
                    'BEGIN:VEVENT',
                    `DTSTART:${dateString}`,
                    `DTEND:${endDateString}`,
                    `SUMMARY:Dinner: ${title}`,
                    `DESCRIPTION:${description}`,
                    'END:VEVENT'
                ]);
            });

            icalContent.push('END:VCALENDAR');
            return icalContent.join('\r\n');
        }

        // Function to download iCal file
        function downloadICalFile(content) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'dinner_schedule.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load settings when modal opens
        optionsBtn.addEventListener('click', loadSettings);

        // Save settings when modal closes
        closeBtn.addEventListener('click', saveSettings);

        // Calendar button click handler
        document.getElementById('createCalendarBtn').addEventListener('click', () => {
            if (currentRecipes.length > 0) {
                const icalContent = createICalContent(currentRecipes);
                downloadICalFile(icalContent);
            }
        });

        // Initialize settings on page load
        loadSettings();

        function animateDiceRoll() {
            const dice = document.createElement('div');
            dice.className = 'dice';
            dice.textContent = 'üé≤';
            document.body.appendChild(dice);
            
            // Remove the dice element after animation
            setTimeout(() => {
                document.body.removeChild(dice);
            }, 2000);
        }

        function showIngredients(ingredients) {
            const modal = document.getElementById('ingredientsModal');
            const list = document.getElementById('ingredientsList');
            
            let html = '<ul class="ingredients-list">';
            ingredients.split(',').forEach(ingredient => {
                const trimmedIngredient = ingredient.trim();
                const searchUrl = `https://www.waitrose.com/ecom/shop/search?&searchTerm=${encodeURIComponent(trimmedIngredient)}`;
                html += `
                    <li>
                        ${trimmedIngredient}
                        <a href="${searchUrl}" target="_blank">Shop</a>
                    </li>
                `;
            });
            html += '</ul>';
            
            list.innerHTML = html;
            modal.style.display = 'block';
        }

        function showRegularItems() {
            const modal = document.getElementById('ingredientsModal');
            const list = document.getElementById('ingredientsList');
            
            const regularItems = document.cookie.split(';')
                .find(row => row.trim().startsWith('regularItems='));
            const regularItemsValue = regularItems ? 
                decodeURIComponent(regularItems.split('=')[1]) : '';
            
            let html = '<ul class="ingredients-list">';
            regularItemsValue.split(',').forEach((item, index) => {
                const trimmedItem = item.trim();
                if (!trimmedItem) return; // Skip empty items
                const searchUrl = `https://www.waitrose.com/ecom/shop/search?&searchTerm=${encodeURIComponent(trimmedItem)}`;
                html += `
                    <li>
                        <div class="item-content">
                            <input type="checkbox" id="item-${index}" class="item-checkbox">
                            <span class="item-text">${trimmedItem}</span>
                        </div>
                        <a href="${searchUrl}" target="_blank" 
                           onclick="document.getElementById('item-${index}').checked = true">Shop</a>
                    </li>
                `;
            });
            html += '</ul>';
            
            list.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeIngredientsModal() {
            document.getElementById('ingredientsModal').style.display = 'none';
        }

        function saveRegularItems() {
            const regularItems = document.getElementById('regularItems').value
                .split(/[\n,]/) // Split by newline or comma
                .map(item => item.trim())
                .filter(item => item.length > 0) // Remove empty items
                .join(',');

            const oneYear = 365 * 24 * 60 * 60 * 1000;
            const expires = new Date(Date.now() + oneYear).toUTCString();
            document.cookie = `regularItems=${encodeURIComponent(regularItems)}; expires=${expires}; path=/`;
            
            const showRegularsBtn = document.getElementById('showRegularsBtn');
            showRegularsBtn.style.display = regularItems ? 'inline-block' : 'none';
            
            alert('Regular items saved successfully!');
        }

        document.getElementById('showRegularsBtn').addEventListener('click', showRegularItems);

        function rerollDay(index) {
            const recipes = getCookies();
            if (recipes.length === 0) return;

            // Get a new random recipe
            let newRecipe;
            let attempts = 0;
            const maxAttempts = 10; // Prevent infinite loop
            let isDuplicate;
            
            do {
                const randomIndex = Math.floor(Math.random() * recipes.length);
                newRecipe = recipes[randomIndex];
                attempts++;
                // Compare titles instead of full objects
                isDuplicate = currentRecipes.some(recipe => 
                    (recipe.title || recipe) === (newRecipe.title || newRecipe)
                );
            } while (attempts < maxAttempts && currentRecipes.length > 1 && isDuplicate);

            // Update the current recipes array
            currentRecipes[index] = newRecipe;

            // Update just this day's display
            const dayElement = document.getElementById(`day-${index + 1}`);
            if (!dayElement) {
                console.error('Day element not found:', index + 1);
                return;
            }

            const title = newRecipe.title || newRecipe;
            const url = newRecipe.url || newRecipe;
            const cleanUrl = getCleanRecipeUrl(url);
            
            // Escape any quotes in the ingredients string
            const ingredientsStr = newRecipe.ingredients ? 
                newRecipe.ingredients.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
            
            dayElement.innerHTML = `
                <div class="day-label">Day ${index + 1}</div>
                <div>
                    <a href="${cleanUrl}" target="_blank">${title}</a>
                    ${newRecipe.ingredients ? 
                        `<button class="ingredients-btn" onclick="showIngredients('${ingredientsStr}')">Ingredients</button>` 
                        : ''}
                </div>
                <button class="reroll-btn" onclick="rerollDay(${index})">üé≤ Re-roll Day ${index + 1}</button>
            `;

            // Add a brief animation to show the change
            dayElement.style.animation = 'none';
            dayElement.offsetHeight; // Trigger reflow
            dayElement.style.animation = 'highlight 1s ease-in-out';
        }

        // Add this debug function to help troubleshoot
        function debugCookies() {
            console.log('All cookies:', document.cookie);
            console.log('Parsed recipes:', getCookies());
        }

        function clearAllRecipes() {
            if (confirm('Are you sure you want to delete all recipes? This cannot be undone.')) {
                // Clear all recipe cookies
                const recipePrefix = 'recipe_';
                document.cookie.split(';').forEach(cookie => {
                    const [key] = cookie.trim().split('=');
                    if (key.startsWith(recipePrefix)) {
                        document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
                    }
                });
                
                alert('All recipes have been cleared.');
                viewRecipes(); // Refresh the view
                modal.style.display = "none"; // Close the modal
            }
        }

        document.getElementById('clearRecipesBtn').addEventListener('click', clearAllRecipes);

        function exportRegularItems() {
            const regularItems = document.getElementById('regularItems').value;
            if (!regularItems.trim()) {
                alert("No regular items to export!");
                return;
            }

            // Format items one per line
            const formattedItems = regularItems
                .split(/[\n,]/)
                .map(item => item.trim())
                .filter(item => item.length > 0)
                .join('\n');

            // Create and trigger download
            const blob = new Blob([formattedItems], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'regular_shopping_items.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importRegularItems() {
            document.getElementById('regularItemsFile').click();
        }

        function handleRegularItemsImport(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    const items = content
                        .split('\n')
                        .map(item => item.trim())
                        .filter(item => item.length > 0)
                        .join('\n');
                    
                    document.getElementById('regularItems').value = items;
                    saveRegularItems(); // Save the imported items
                    alert('Regular items imported successfully!');
                } catch (error) {
                    console.error('Error importing regular items:', error);
                    alert('Error importing regular items. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('regularItemsFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                handleRegularItemsImport(file);
                event.target.value = ''; // Reset file input
            }
        });
    </script>
</body>
</html> 
